<html>
    <head>
        <title>PowuhGred</title>
    </head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>


    <canvas id="mapCanvas" width="1680" height="1050" style=""></canvas>


    <script>
        var socket = io();
        var citiesDef = {};
        var userid = "NO USER ID";
        var selected;

        var bgImg = new Image();
        bgImg.src = "./data/germany.jpg";

        var mapCanvas = document.getElementById("mapCanvas");
        var ctx = mapCanvas.getContext("2d");

        var consoletext = "Console:";
        var log = function(str) { console.log(str); consoletext += str + "\n"; redraw(); };

        var externalX = function (x) { return x * 1.1 - 5;  };
        var externalY = function (y) { return y * 1.1 - 96; };
        var internalX = function (x) { return (x + 5) / 1.1;  };
        var internalY = function (y) { return (y + 96) / 1.1; };

        var resourceGrid = {};
        for(var i = 0; i < 24; i++) {
            var box = {};
            box.type = "coal";
            box.size = 22;
            box.x = internalX((i * (box.size+3)) + (~~(i / 3) * 5) + 37);
            box.y = internalY(949);
            resourceGrid[i] = box;
        }
        for(var i = 0; i < 24; i++) {
            var box = {};
            box.type = "oil";
            box.size = 17;
            box.x = internalX((i * (box.size)) + (~~(i / 3) * 29) + 37);
            box.y = internalY(971);
            resourceGrid[i+24] = box;
        }
        for(var i = 0; i < 24; i++) {
            var box = {};
            box.type = "trash";
            box.size = 22;
            box.x = internalX((i * (box.size+3)) + (~~(i / 3) * 5) + 37);
            box.y = internalY(990);
            resourceGrid[i+48] = box;
        }
        for(var i = 0; i < 8; i++) {
            var box = {};
            box.type = "uranium";
            if(i <= 9) {
                box.size = 17;
                box.x = internalX(((i*3+2) * (box.size)) + (~~((i*3+2) / 3) * 29) + 37 + 20);
                box.y = internalY(971);
            }
            resourceGrid[i+72] = box;
        }
        for(var i = 0; i < 4; i++) {
            var box = {};
            box.type = "uranium";
            box.size = 25;
            box.x = internalX((~~(i/2) * (box.size+6)) + 678);
            box.y = internalY(951 + ((i%2) * (box.size+11)));
            resourceGrid[i+80] = box;
        }

        var buttonArray = {};
        var createButton = function(disp,cmd,args,x,y,w,h) {
            var button = {};
            button.disp = disp;
            button.cmd = cmd;
            button.args = args;
            button.x = x;
            button.y = y;
            button.width = w;
            button.height = h;
            buttonArray[disp] = button;
        }

        // store user id
        socket.on('userid', function(data) {userid = data});

        // load up the city map right after connecting
        socket.on('definecities', function(data){

            // get the dictionary of city.js objects (taken from cities.js)
            $.each(data, function(key, value){
                citiesDef[key] = value;
            });

            // load the background image
            bgImg.onload = function() {
                redraw();
            };
        });

        socket.on('updates', function(data) {
            log("RECEIVED on updates:");
			log(data.group + " " + data.args);
        });

        var redraw = function() {
            ctx.drawImage(bgImg, 0, 0);

            // draw internal city map
            $.each(citiesDef, function(key, city){
                ctx.strokeStyle = "#444444";
                ctx.fillStyle = "#FFFFFF";
                ctx.lineWidth = 2;
                ctx.beginPath();
                var x = externalX(city.x);
                var y = externalY(city.y);
                ctx.arc(x, y, 20, 0, 360, false);
                ctx.stroke();

                ctx.font = "10px Arial";
                ctx.fillText(city.name.toUpperCase(),x,y);
            });

            // draw internal resource grid
            $.each(resourceGrid, function(key,box) {
                ctx.strokeStyle = "#0000FF";
                if(box.type==="coal") {ctx.strokeStyle = "#FFFFFF";}
                if(box.type==="oil") {ctx.strokeStyle = "#0000FF";}
                if(box.type==="uranium") {ctx.strokeStyle = "#00FF00";}
                if(box.type==="trash") {ctx.strokeStyle = "#FFFF00";}
                ctx.lineWidth = 1;
                ctx.beginPath();
                var x = externalX(box.x);
                var y = externalY(box.y);
                ctx.rect(x,y,box.size,box.size);
                ctx.stroke();
            });

            // highlight selected city
            if(selected) {
                ctx.strokeStyle = "#DD6622";
                ctx.lineWidth = 3;
                ctx.beginPath();
                var x = externalX(selected.x);
                var y = externalY(selected.y);
                ctx.arc(x, y, 20, 0, 360, false);
                ctx.stroke();
            }

            // console output
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(800,40,600,600);
            ctx.fillStyle = "#000000";
            ctx.font = "10px Arial";
            txt = consoletext.split("\n");
            $.each(txt, function(index, chunk) {
                ctx.fillText(chunk,800,40+15*index);
            });

            // draw buttons
            $.each(buttonArray, function(key, btn) {
                ctx.fillStyle = "#777700";
                ctx.strokeStyle = "#777700";
                ctx.lineWidth = 1;
                ctx.strokeRect(externalX(btn.x), externalY(btn.y), btn.width, btn.height)
                ctx.font = "10px Arial";
                ctx.fillText(btn.disp,externalX(btn.x+6),externalY(btn.y+btn.height-4));
            });
        }

        var sqrDist = function(x1,x2,y1,y2) { return Math.pow(x1-x2,2)+Math.pow(y1-y2,2) }

        mapCanvas.addEventListener('click', function(event) {
            var x = internalX(event.pageX - 8),
                y = internalY(event.pageY - 8);

            $.each(buttonArray,function(key, btn) {
                if(x > btn.x && x < (btn.x + btn.width) && y > btn.y && y < (btn.y + btn.height)) {
                    log("SENDING " + btn.cmd + " on gameaction");
                    socket.emit('gameaction', {uid:userid, cmd:btn.cmd, args:btn.args});
                    return;
                }
            });

            selected = null;
            $.each(citiesDef,function(key,city) {
                if(sqrDist(x,city.x,y,city.y)<500) {selected = city;}
            });
            redraw();
        },false);


        // createButton( Display, Cmd, Args, x,y,w,h);
        createButton("startGame","startGame","",720,90,60,12);
        createButton("pass","pass","",785,90,60,12);

    </script>


</html>