<html>
    <head>
        <title>PowuhGred</title>
    </head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <canvas id="mapCanvas" width="1680" height="1050" style=""></canvas>

	<input type="text" id="chatInputBox"
		   style="position:absolute;left:800px;top:600px;width:300px;" onkeypress="handleChatInput(event)"/>

    <script>
		var DEBUG = false;

		var currentActionState = "unstarted";

		var UNSTARTED_F =	1;              //bitwise 000001
		var AUCTION_F =		2;              //bitwise 000010
		var BID_F = 		4;              //bitwise 000100
		var RESOURCE_F = 	8;              //bitwise 001000
		var CITY_F =		16;             //bitwise 010000
		var MONEY_F =		32;             //bitwise 100000

        //initiates Color Vars
        var WHITE =     "#FFFFFF";
        var BLACK =     "#000000";
        var GRAY =      "#444444";
        var BROWN =     "#452E17";
        var BLUE =      "#0000FF";
        var LTBLUE =    "#00B8E6";
        var GREEN =     "#009900";
        var LTGREEN =   "#00CC00";
        var YELLOW =    "#FFFF19";
        var PINK =      "#FF6699";
        var ORANGE =    "#DD6622";
		var RED =		"#E62E2E";

        // Used for enabling/disabling buttons
		var ACTIONS_FLAGS = [];
		ACTIONS_FLAGS[currentActionState] = UNSTARTED_F;
		ACTIONS_FLAGS["startAuction"] = AUCTION_F | BID_F;  //| is bitwise OR command, 000010 OR 000100 = 000110 => 6
		ACTIONS_FLAGS["bid"] = BID_F;
		ACTIONS_FLAGS["buyResources"] = RESOURCE_F;
		ACTIONS_FLAGS["buyCities"] = CITY_F;
		ACTIONS_FLAGS["moneyPhase"] = MONEY_F;

        var socket = io();
        var citiesDef = {};
        var selectedCity;

		var selectedBid = 0;
		var selectedPlant = -1;

		// Global stuff
		var resources = {};
		var actualMarket = [];
		var futureMarket = [];
        var scorePanel = {};

		var playerData = {
			self:{
				ownedPlants:[]
			},
			others:{}
		};

        // Initialize images for Map and PowerPlant Cards
        // Power Plant cards are located all in one .jpg with specific format labeled below
        var bgImg = new Image();
        bgImg.src = "./data/germany.jpg";
		var plantImg = new Image();
		plantImg.src = "./data/plants.jpg";

        // mapCanvas is map image area
        var mapCanvas = document.getElementById("mapCanvas");
        var ctx = mapCanvas.getContext("2d");           // NOTSURE: what is context?

        // initializations and functions for console input/output
        var consoleHeader = "Console:\n";
		var CONSOLE_O = "console";
		var CHAT_O = "chat";
		var outputDisplays = {
			chat:{text:"\t= Chat =\n",history:[],header:"\t= Chat =\n"},
			console:{text:"\t- Console -\n",history:[],header:"\t- Console -\n"}
		};

        // This function used to add to output of chat panel in game
        var log = function(str, output) {
			console.log(output + " => " + str);
			var output = outputDisplays[output];
			output.history.push(str);
			if(output.history.length > 15)
				output.history.splice(0, 1);
			output.text = output.header;
			for(var line in output.history){
				output.text += output.history[line] + "\n";
			}
			redraw();
		};

        //Used to transform between external and internal coordinates (must be for map)
        var externalX = function (x) { return x * 1.1 - 5;  };
        var externalY = function (y) { return y * 1.1 - 96; };
        var internalX = function (x) { return (x + 5) / 1.1;  };
        var internalY = function (y) { return (y + 96) / 1.1; };

        var resourceGrid = {};

		// V V V Talk to Kyle before changing ANYTHING V V V
        // black changed so Duplicate Vars bs wouldn't keep showing up
        for(var i = 0; i < 24; i++) {
            var box = {};
            box.type = "coal";
            box.size = 22;
            box.x = internalX((i * (box.size+3)) + (~~(i / 3) * 5) + 37);
            box.y = internalY(949);
            resourceGrid[i] = box;
        }
        for(i = 0; i < 24; i++) {
            box = {};
            box.type = "oil";
            box.size = 17;
            box.x = internalX((i * (box.size)) + (~~(i / 3) * 29) + 37);
            box.y = internalY(971);
            resourceGrid[i+24] = box;
        }
        for(i = 0; i < 24; i++) {
            box = {};
            box.type = "garbage";
            box.size = 22;
            box.x = internalX((i * (box.size+3)) + (~~(i / 3) * 5) + 37);
            box.y = internalY(990);
            resourceGrid[i+48] = box;
        }
        for(i = 0; i < 8; i++) {
            box = {};
            box.type = "uranium";
            if(i <= 9) {
                box.size = 17;
                box.x = internalX(((i*3+2) * (box.size)) + (~~((i*3+2) / 3) * 29) + 37 + 20);
                box.y = internalY(971);
            }
            resourceGrid[i+72] = box;
        }
        for(i = 0; i < 4; i++) {
            box = {};
            box.type = "uranium";
            box.size = 25;
            box.x = internalX(((i%2) * (box.size+6)) + 678);
            box.y = internalY(951 + (~~(i/2) * (box.size+11)));
            resourceGrid[i+80] = box;
        }
		// ^ ^ ^ OK, YOU CAN DO SHIT NOW ^ ^ ^

        // initializes buttonArray and function for making buttons
        // solely for buttons at top of window (start game, bidding, etc.)
        var buttonArray = {};
        var createButton = function(disp,listener,flags) {
            var button = {};
            button.disp = disp;

			// function to call when clicked
            button.listener = listener;

			// when this button should appear
			button.flags = flags;

			// The width of even monospace font isn't very even :(
			// so I hacked up something that kinda seems to work
            button.width = disp.length > 5 ?
					(disp.length > 8 ? disp.length * 8 : disp.length * 9)
					: disp.length * 10;
            button.height = 12;
            buttonArray[disp] = button;
        };

		var handleChatInput = function(event){
			var key= event.keyCode || event.which;
			if(key == 13) {
				var input = document.getElementById('chatInputBox').value;
				socket.emit('sendchat', input);
				document.getElementById('chatInputBox').value = "";
			}
		};

		var updatePlayerPlants = function(data){

		};

		var updateBidWin = function(data){
			log(data.displayName + " has won the bid for the power plant", CHAT_O);
		};

		var updateDisplayName = function(data){
			log("* " + data.oldDisplayName + " changed their name to " + data.displayName + " *", CHAT_O);
		};

		var updateResources = function(data){
			log("Oil: " + data.oil + " - Coal: " + data.coal
					+ " - Garbage: " + data.garbage + " - Uranium: " + data.uranium, CONSOLE_O);
			resources = data;
		};

        // Currently only outputs log
		var updatePlayerOrder = function(data){
			log("Player Order: " + data, CONSOLE_O);
		};

        // Currently only outputs log
		var updateCurrentPlayer = function(data){
			log("Current Player: " + data, CONSOLE_O);
		};

        // Outputs Log, and changes actual market, data looks like power plant data
		var updateActualMarket = function(data){
			log("Actual Market =>", CONSOLE_O);
			actualMarket = [];
			for(var m in data){
				log("Cost: " + data[m].cost + " Type: " + data[m].type
					+ " Requires: " + data[m].requires + " Powers: " + data[m].powers, CONSOLE_O);
				actualMarket.push(data[m].cost);
			}
		};

        // Outputs Log, changes future market, data looks like power plant data
		var updateFutureMarket = function(data){
			log("Future Market =>", CONSOLE_O);
			futureMarket = [];
			for(var m in data){
				log("Cost: " + data[m].cost + " Type: " + data[m].type
					+ " Requires: " + data[m].requires + " Powers: " + data[m].powers, CONSOLE_O);
				futureMarket.push(data[m].cost);
			}
		};

		var updateCurrentAction = function(data){
			log("Current Action: " + data, CONSOLE_O);
			currentActionState = data;
		};

        // Currently only Outputs a Log
		var updateMoney = function(data){
			log(data.uid + " now has " + data.money + " money", CONSOLE_O);
		};

        // Currently only Outputs a Log
		var updateNewPlayer = function(data){
			log(data.uid + " has joined the game", CONSOLE_O);
		};

        // Currently only Outputs a Log
		var updatePlayerName = function(data){
			log(data.uid + " has changed their name to " + data.displayName, CONSOLE_O);
		};

        // Currently only Outputs a Log
		var updateStartAuction = function(data){
			log(data.uid + " has started an auction on power plant: "
					+ data.cost + " with bid " + data.bid, CONSOLE_O);
		};

        // Currently only Outputs a Log
		var updateNewBid = function(data){
			log(data.uid + " placed a new bid of " + data.bid, CONSOLE_O);
		};

        // Currently only Outputs a Log
        var updateCurrentBidder = function(data){
            log(data.uid + " must now place a bid or pass", CONSOLE_O);
        };

        // sets up data for the panel of players + scores along the side,
        // drawn by redraw.js -> scorepanel.js::drawScorePanel
        var updateScorePanel = function(data){
            scorePanel = data;
            scorePanel.anim = {};
            scorePanel.anim.progress = 0;
        };

        var sqrDist = function(x1,x2,y1,y2) { return Math.pow(x1-x2,2)+Math.pow(y1-y2,2) };

        // Listen for clicks
        mapCanvas.addEventListener('click', function(event) {
            var x = event.pageX - 8;
			var y = event.pageY - 8;

			if(DEBUG){
				log("Click: " + x + ", " + y, CONSOLE_O);
			}

            for(key in buttonArray) {
				var btn = buttonArray[key];
                if(x > btn.x && x < (btn.x + btn.width) && y > btn.y && y < (btn.y + btn.height)) {
                    btn.listener();
					return;
                }
            }

			if(x > 800 && x < 1280 && y > 300 && y < 420){
				selectedPlant = 3-(Math.floor((1260 - x) / 114));
				selectedCity = null;
                redraw();
				return;
			}

			x = internalX(event.pageX - 8);
			y = internalY(event.pageY - 8);
            $.each(citiesDef,function(key,city) {
                if(sqrDist(x,city.x,y,city.y)<500) {selectedCity = city;selectedPlant = -1;}
            });
            redraw();
        },false);

		var startGameButton = function(){
			socket.emit('gameaction', {uid:playerData.self.uid, cmd:"startGame", args:{}});
            animStartGame();
		};

		var passButton = function(){
			socket.emit('gameaction', {uid:playerData.self.uid, cmd:currentActionState, args:"pass"});
		};

		var startAuctionButton = function(){
			if(selectedPlant != -1){
				socket.emit('gameaction', {uid: playerData.self.uid, cmd: "startAuction",
					args: {cost: actualMarket[selectedPlant], bid: selectedBid}});
			}
			else{
				log("Select a power plant first.", CONSOLE_O);
			}
		};

		var bidUpButton = function(){
			selectedBid += 1;
			log("Bid amount: $" + selectedBid, CONSOLE_O);
		};

		var bidDownButton = function(){
			if(selectedBid <= 0)
				selectedBid = 0;
			else
				selectedBid -= 1;
			log("Bid amount: $" + selectedBid, CONSOLE_O);
		};

		var confirmBidButton = function(){
			socket.emit('gameaction', {uid:playerData.self.uid, cmd:"bid", args:{bid:selectedBid}});
		};

        // createButton( Display String, listener, buttons flags);
        createButton("Start Game!", startGameButton, UNSTARTED_F);
        createButton("Pass", passButton, AUCTION_F | BID_F | RESOURCE_F | CITY_F | MONEY_F);
		createButton("Start Auction", startAuctionButton, AUCTION_F);
		createButton("Bid Up", bidUpButton, AUCTION_F | BID_F);
		createButton("Bid Down", bidDownButton, AUCTION_F | BID_F);
		createButton("Confirm Bid", confirmBidButton, AUCTION_F | BID_F);

    </script>

	<script src="/includes/redraw.js"></script>
    <script src="/includes/sockethandlers.js"></script>
    <script src="/includes/scorepanel.js"></script>
	<script src="/includes/cardpositions.js"></script>


</html>