<html>
    <head>
        <title>PowuhGred</title>
    </head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>


    <canvas id="mapCanvas" width="1680" height="1050" style=""></canvas>

	<input type="text" id="chatInputBox"
		   style="position:absolute;left:800px;top:600px;width:300px;" onkeypress="handleChatInput(event)"/>

    <script>
		var DEBUG = false;

		var currentActionState = "unstarted";

		var UNSTARTED_F =	1;              //bitwise 000001
		var AUCTION_F =		2;              //bitwise 000010
		var BID_F = 		4;              //bitwise 000100
		var RESOURCE_F = 	8;              //bitwise 001000
		var CITY_F =		16;             //bitwise 010000
		var MONEY_F =		32;             //bitwise 100000

        //initiates Color Vars
        var WHITE =     "#FFFFFF";
        var BLACK =     "#000000";
        var GRAY =      "#444444";
        var BROWN =     "#452E17";
        var BLUE =      "#0000FF";
        var LTBLUE =    "#00B8E6";
        var GREEN =     "#009900";
        var LTGREEN =   "#00CC00";
        var YELLOW =    "#FFFF19";
        var PINK =      "#FF6699";
        var ORANGE =    "#DD6622";

        // Not sure what these do yet
		var ACTIONS_FLAGS = [];
		ACTIONS_FLAGS[currentActionState] = UNSTARTED_F;
		ACTIONS_FLAGS["startAuction"] = AUCTION_F | BID_F;  //| is bitwise OR command, 000010 OR 000100 = 000110 => 6
		ACTIONS_FLAGS["bid"] = BID_F;
		ACTIONS_FLAGS["buyResources"] = RESOURCE_F;
		ACTIONS_FLAGS["buyCities"] = CITY_F;
		ACTIONS_FLAGS["moneyPhase"] = MONEY_F;

        var socket = io();
        var citiesDef = {};
        var userid = "NO USER ID";
        var selectedCity;

		var selectedBid = 0;
		var selectedPlant = -1;

		// Global stuff
		var resources = {};
		var actualMarket = [];
		var futureMarket = [];

		// Player stuff
		var ownedPlants = [];

        // Initialize images for Map and PowerPlant Cards
        // Power Plant cards are located all in one .jpg with specific format labeled below
        var bgImg = new Image();
        bgImg.src = "./data/germany.jpg";
		var plantImg = new Image();
		plantImg.src = "./data/plants.jpg";

        // mapCanvas is map image area
        var mapCanvas = document.getElementById("mapCanvas");
        var ctx = mapCanvas.getContext("2d");           // NOTSURE: what is context?

        // initializations and functions for console input/output
        var consoleHeader = "Console:\n";
		var CONSOLE_O = "console";
		var CHAT_O = "chat";
		var outputDisplays = {
			chat:{text:"\t= Chat =\n",history:[],header:"\t= Chat =\n"},
			console:{text:"\t- Console -\n",history:[],header:"\t- Console -\n"}
		};

        // This function used to add to output of chat panel in game
        var log = function(str, output) {
			console.log(output + " => " + str);
			var output = outputDisplays[output];
			output.history.push(str);
			if(output.history.length > 15)
				output.history.splice(0, 1);
			output.text = output.header;
			for(var line in output.history){
				output.text += output.history[line] + "\n";
			}
			redraw();
		};

        //Used to transform between external and internal coordinates (must be for map)
        var externalX = function (x) { return x * 1.1 - 5;  };
        var externalY = function (y) { return y * 1.1 - 96; };
        var internalX = function (x) { return (x + 5) / 1.1;  };
        var internalY = function (y) { return (y + 96) / 1.1; };

        var resourceGrid = {};

		// V V V Talk to Kyle before changing ANYTHING V V V
        // black changed so Duplicate Vars bs wouldn't keep showing up
        for(var i = 0; i < 24; i++) {
            var box = {};
            box.type = "coal";
            box.size = 22;
            box.x = internalX((i * (box.size+3)) + (~~(i / 3) * 5) + 37);
            box.y = internalY(949);
            resourceGrid[i] = box;
        }
        for(i = 0; i < 24; i++) {
            box = {};
            box.type = "oil";
            box.size = 17;
            box.x = internalX((i * (box.size)) + (~~(i / 3) * 29) + 37);
            box.y = internalY(971);
            resourceGrid[i+24] = box;
        }
        for(i = 0; i < 24; i++) {
            box = {};
            box.type = "garbage";
            box.size = 22;
            box.x = internalX((i * (box.size+3)) + (~~(i / 3) * 5) + 37);
            box.y = internalY(990);
            resourceGrid[i+48] = box;
        }
        for(i = 0; i < 8; i++) {
            box = {};
            box.type = "uranium";
            if(i <= 9) {
                box.size = 17;
                box.x = internalX(((i*3+2) * (box.size)) + (~~((i*3+2) / 3) * 29) + 37 + 20);
                box.y = internalY(971);
            }
            resourceGrid[i+72] = box;
        }
        for(i = 0; i < 4; i++) {
            box = {};
            box.type = "uranium";
            box.size = 25;
            box.x = internalX(((i%2) * (box.size+6)) + 678);
            box.y = internalY(951 + (~~(i/2) * (box.size+11)));
            resourceGrid[i+80] = box;
        }
		// ^ ^ ^ OK, YOU CAN DO SHIT NOW ^ ^ ^

        // initializes buttonArray and function for making buttons
        // solely for buttons at top of window (start game, bidding, etc.)
        // Disp is string displayed on button, NOTSURE: what listener/flags do
        var buttonArray = {};
        var createButton = function(disp,listener,flags) {
            var button = {};
            button.disp = disp;
            button.listener = listener;
			button.flags = flags;
            button.width = disp.length > 5 ?
					(disp.length > 8 ? disp.length * 8 : disp.length * 9)
					: disp.length * 10;
            button.height = 12;
            buttonArray[disp] = button;
        };

		var handleChatInput = function(event){
			var key= event.keyCode || event.which;
			if(key == 13) {
				var input = document.getElementById('chatInputBox').value;
				socket.emit('sendchat', input);
				document.getElementById('chatInputBox').value = "";
			}
		};

        // store user id
        socket.on('userid', function(data) {userid = data});

        // load up the city map right after connecting
        socket.on('definecities', function(data){

            // get the dictionary of city.js objects (taken from cities.js)
            $.each(data, function(key, value){
                citiesDef[key] = value;
            });

            // load the background image
            bgImg.onload = function() {
                redraw();
            };
        });

        // NOTSURE: what the data format for input is
        socket.on('updates', function(data) {
			if(data.group == "resourcePool"){
				updateResources(data.args);
			}
			else if(data.group == "playerOrder"){
				updatePlayerOrder(data.args);
			}
			else if(data.group == "currentPlayer"){
				updateCurrentPlayer(data.args);
			}
			else if(data.group == "actualMarket"){
				updateActualMarket(data.args);
			}
			else if(data.group == "futureMarket"){
				updateFutureMarket(data.args);
			}
			else if(data.group == "currentAction"){
				updateCurrentAction(data.args);
			}
			else if(data.group == "money"){
				updateMoney(data.args);
			}
			else if(data.group == "newPlayer"){
				updateNewPlayer(data.args);
			}
			else if(data.group == "name"){
				updatePlayerName(data.args);
			}
			else if(data.group == "auctionStart"){
				updateStartAuction(data.args);
			}
			else if(data.group == "bid"){
				updateNewBid(data.args);
			}
			else if(data.group == "currentBidder"){
				updateCurrentBidder(data.args);
			}
			else if(data.group == "displayName"){
				updateDisplayName(data.args);
			}
			else{
				log("'" + data.group + "' has no handler!", CONSOLE_O);
			}
			redraw();
        });

		socket.on('updatechat', function(data) {
			log(data.sender + ": " + data.msg, CHAT_O);
		});

		var updateDisplayName = function(data){
			log("* " + data.oldDisplayName + " changed their name to " + data.displayName + " *", CHAT_O);
		};

		var updateResources = function(data){
			log("Oil: " + data.oil + " - Coal: " + data.coal
					+ " - Garbage: " + data.garbage + " - Uranium: " + data.uranium, CONSOLE_O);
			resources = data;
		};

        // Currently only outputs log
		var updatePlayerOrder = function(data){
			log("Player Order: " + data, CONSOLE_O);
		};

        // Currently only outputs log
		var updateCurrentPlayer = function(data){
			log("Current Player: " + data, CONSOLE_O);
		};

        // Outputs Log, and changes actual market, data looks like power plant data
		var updateActualMarket = function(data){
			log("Actual Market =>", CONSOLE_O);
			actualMarket = [];
			for(var m in data){
				log("Cost: " + data[m].cost + " Type: " + data[m].type
					+ " Requires: " + data[m].requires + " Powers: " + data[m].powers, CONSOLE_O);
				actualMarket.push(data[m].cost);
			}
		};

        // Outputs Log, changes future market, data looks like power plant data
		var updateFutureMarket = function(data){
			log("Future Market =>", CONSOLE_O);
			futureMarket = [];
			for(var m in data){
				log("Cost: " + data[m].cost + " Type: " + data[m].type
					+ " Requires: " + data[m].requires + " Powers: " + data[m].powers, CONSOLE_O);
				futureMarket.push(data[m].cost);
			}
		};

		var updateCurrentAction = function(data){
			log("Current Action: " + data, CONSOLE_O);
			currentActionState = data;
		};

        // Currently only Outputs a Log
		var updateMoney = function(data){
			log(data.uid + " now has " + data.money + " money", CONSOLE_O);
		};

        // Currently only Outputs a Log
		var updateNewPlayer = function(data){
			log(data.uid + " has joined the game", CONSOLE_O);
		};

        // Currently only Outputs a Log
		var updatePlayerName = function(data){
			log(data.uid + " has changed their name to " + data.displayName, CONSOLE_O);
		};

        // Currently only Outputs a Log
		var updateStartAuction = function(data){
			log(data.uid + " has started an auction on power plant: "
					+ data.cost + " with bid " + data.bid, CONSOLE_O);
		};

        // Currently only Outputs a Log
		var updateNewBid = function(data){
			log(data.uid + " placed a new bid of " + data.bid, CONSOLE_O);
		};

        // Currently only Outputs a Log
		var updateCurrentBidder = function(data){
			log(data.uid + " must now place a bid or pass", CONSOLE_O);
		};

        var redraw = function() {
            // Fills background with white
			ctx.fillStyle = WHITE;
			ctx.fillRect(0,0,1680,1050);
            ctx.drawImage(bgImg, 0, 0);

            // draw internal city map
            $.each(citiesDef, function(key, city){
                ctx.strokeStyle = GRAY;
                ctx.fillStyle = WHITE;
                ctx.lineWidth = 2;
				if(DEBUG){
					ctx.beginPath();
					var x = externalX(city.x);
					var y = externalY(city.y);
					ctx.arc(x, y, 20, 0, 360, false);
					ctx.stroke();

					ctx.font = "10px Arial";
					ctx.fillText(city.name.toUpperCase(),x,y);
				}
            });

            // draw internal resource grid
			var regular = 24;
			var uranium = 12;
            $.each(resourceGrid, function(key,box) {
                ctx.strokeStyle = BLUE;
                if(box.type==="coal") {ctx.strokeStyle = ctx.fillStyle = BROWN;}
                if(box.type==="oil") {ctx.strokeStyle = ctx.fillStyle = BLACK;}
                if(box.type==="uranium") {ctx.strokeStyle = ctx.fillStyle = PINK;}
                if(box.type==="garbage") {ctx.strokeStyle = ctx.fillStyle = YELLOW;}
                ctx.lineWidth = 1;


				var x = externalX(box.x);
				var y = externalY(box.y);

				if(DEBUG){
					ctx.beginPath();
					ctx.rect(x, y, box.size, box.size);
					ctx.stroke();
				}

				// Draw resource unit
				if(box.type == "coal" && key % regular  >= 24 - resources.coal){
					ctx.fillRect(x + box.size / 8,y + box.size / 8,
									box.size * (3/4),box.size * (3/4));
				}
				if(box.type == "oil" && key % regular  >= 24 - resources.oil){
					ctx.fillRect(x + box.size / 8,y + box.size / 8,
									box.size * (3/4),box.size * (3/4));
				}
				if(box.type == "garbage" && key % regular  >= 24 - resources.garbage){
					ctx.fillRect(x + box.size / 8,y + box.size / 8,
									box.size * (3/4),box.size * (3/4));
				}
				if(box.type == "uranium" && key % uranium  >= 12 - resources.uranium){
					ctx.fillRect(x + box.size / 8,y + box.size / 8,
									box.size * (3/4),box.size * (3/4));
				}
            });

            // highlight selected city
            if(selectedCity) {
                ctx.strokeStyle = ORANGE;
                ctx.lineWidth = 3;
                ctx.beginPath();
                var x = externalX(selectedCity.x);
                var y = externalY(selectedCity.y);
                ctx.arc(x, y, 20, 0, 360, false);
                ctx.stroke();
            }

            // draws a selection box on a plant if it's selected (not selected = -1)
			if(selectedPlant>=0){
				ctx.strokeStyle = ORANGE;
				ctx.lineWidth = 5;
				ctx.beginPath();
				x = (800 + (selectedPlant * 120)); //Changed 114 => 120 to account for spaces
				y = 300;
				ctx.strokeRect(x, y, 114, 114);
				ctx.stroke();
                ctx.stroke();
			}

            // console output
            ctx.fillStyle = BLACK;
            ctx.font = "10px Arial";
            var txt = outputDisplays[CHAT_O].text.split("\n");
            $.each(txt, function(index, chunk) {
                ctx.fillText(chunk,800,650+15*index);
            });

			txt = outputDisplays[CONSOLE_O].text.split("\n");
			$.each(txt, function(index, chunk) {
				ctx.fillText(chunk,1200,650+15*index);
			});

			// Draw the player's power plants
			var count = 0;
			for(var p in ownedPlants){
				var cost = ownedPlants[p];
				ctx.drawImage(plantImg, ppp[cost].x * pppWidth, ppp[cost].y * pppHeight,
									pppWidth, pppHeight,
									800 + count * 125, 150, pppWidth, pppHeight);
				count += 1;
			}

			// Draw the actual market
			count = 0;
			ctx.strokeStyle = LTBLUE;
			ctx.lineWidth = 1;
			ctx.strokeRect(794, 294, 4 * 120 + 7, 125);
			for(p in actualMarket){
				cost = actualMarket[p];
				ctx.drawImage(plantImg, ppp[cost].x * pppWidth, ppp[cost].y * pppHeight,
									pppWidth, pppHeight,
									800 + count * 120, 300, pppWidth, pppHeight);
				count += 1;
			}

			// Draw the future market
			count = 0;
			ctx.strokeStyle = PINK;
			ctx.strokeRect(794, 444, 4 * 120 + 7, 125);
			for(p in futureMarket){
				cost = futureMarket[p];
				ctx.drawImage(plantImg, ppp[cost].x * pppWidth, ppp[cost].y * pppHeight,
									pppWidth, pppHeight,
									800 + count * 120, 450, pppWidth, pppHeight);
				count += 1;
			}


            // draw buttons
			ctx.fillStyle = WHITE;
			var currentWidth = 800;
			var bufferSpace = 5;
            for(key in buttonArray) {
				var btn = buttonArray[key];

				var cur = ACTIONS_FLAGS[currentActionState];
				var flag = btn.flags;
				if((cur & flag) > 0){
					ctx.fillStyle = GREEN;
					ctx.strokeStyle = GREEN;
					ctx.lineWidth = 1;
					var pos = currentWidth;
					btn.x = pos;
					btn.y = 5;
					ctx.strokeRect(pos, 5, btn.width, btn.height);
					ctx.font = "12px monospace";
					ctx.fillText(btn.disp, pos + 5, 15);
					currentWidth = pos + btn.width + bufferSpace;
				}
				else{
					btn.x = -1;
					btn.y = -1;
				}
            }

			// Draw bid amount box
			if((ACTIONS_FLAGS[currentActionState] & (AUCTION_F | BID_F)) > 0){
				ctx.strokeStyle = GREEN;
				ctx.font = "14px monospace";
				ctx.fillText("Current Bid: " + selectedBid, 800, 30);
				ctx.fillText("Highest Bid: N/A", 925, 30);
			}
        };

        var sqrDist = function(x1,x2,y1,y2) { return Math.pow(x1-x2,2)+Math.pow(y1-y2,2) };

        // Listen for clicks
        mapCanvas.addEventListener('click', function(event) {
            var x = event.pageX - 8;
			var y = event.pageY - 8;

			if(DEBUG){
				log("Click: " + x + ", " + y, CONSOLE_O);
			}

            for(key in buttonArray) {
				var btn = buttonArray[key];
                if(x > btn.x && x < (btn.x + btn.width) && y > btn.y && y < (btn.y + btn.height)) {
                    btn.listener();
					return;
                }
            }

			if(x > 800 && x < 1280 && y > 300 && y < 420){
				selectedPlant = 3-(Math.floor((1260 - x) / 114));
				selectedCity = null;
                redraw();
				return;
			}

			x = internalX(event.pageX - 8);
			y = internalY(event.pageY - 8);
            $.each(citiesDef,function(key,city) {
                if(sqrDist(x,city.x,y,city.y)<500) {selectedCity = city;selectedPlant = -1;}
            });
            redraw();
        },false);

		var startGameButton = function(){
			socket.emit('gameaction', {uid:userid, cmd:"startGame", args:{}});
		};

		var passButton = function(){
			socket.emit('gameaction', {uid:userid, cmd:"pass", args:{}});
		};

		var startAuctionButton = function(){
			if(selectedPlant != -1){
				socket.emit('gameaction', {uid: userid, cmd: "startAuction",
					args: {cost: actualMarket[selectedPlant], bid: selectedBid}});
			}
			else{
				log("Select a power plant first.", CONSOLE_O);
			}
		};

		var bidUpButton = function(){
			selectedBid += 1;
			log("Bid amount: $" + selectedBid, CONSOLE_O);
		};

		var bidDownButton = function(){
			if(selectedBid <= 0)
				selectedBid = 0;
			else
				selectedBid -= 1;
			log("Bid amount: $" + selectedBid, CONSOLE_O);
		};

		var confirmBidButton = function(){
			socket.emit('gameaction', {uid:userid, cmd:"bid", args:{bid:selectedBid}});
		};

        // createButton( Display String, listener, buttons flags);
        createButton("Start Game!", startGameButton, UNSTARTED_F);
        createButton("Pass", passButton, AUCTION_F | BID_F | RESOURCE_F | CITY_F | MONEY_F);
		createButton("Start Auction", startAuctionButton, AUCTION_F);
		createButton("Bid Up", bidUpButton, AUCTION_F | BID_F);
		createButton("Bid Down", bidDownButton, AUCTION_F | BID_F);
		createButton("Confirm Bid", confirmBidButton, AUCTION_F | BID_F);

		// Card positions
		var pppWidth = 114;
		var pppHeight = 114;
		var ppp = [];
		ppp[3]  = {x:0,y:1};
		ppp[4]  = {x:0,y:0};
		ppp[5]  = {x:0,y:2};
		ppp[6]  = {x:0,y:3};
		ppp[7]  = {x:1,y:1};
		ppp[8]  = {x:1,y:0};
		ppp[9]  = {x:2,y:1};
		ppp[10] = {x:2,y:0};
		ppp[11] = {x:0,y:4};
		ppp[12] = {x:1,y:2};
		ppp[13] = {x:0,y:5};
		ppp[14] = {x:1,y:3};
		ppp[15] = {x:3,y:0};
		ppp[16] = {x:3,y:1};
		ppp[17] = {x:1,y:4};
		ppp[18] = {x:1,y:5};
		ppp[19] = {x:2,y:3};
		ppp[20] = {x:4,y:0};
		ppp[21] = {x:2,y:2};
		ppp[22] = {x:2,y:5};
		ppp[23] = {x:2,y:4};
		ppp[24] = {x:3,y:3};
		ppp[25] = {x:5,y:0};
		ppp[26] = {x:4,y:1};
		ppp[27] = {x:3,y:5};
		ppp[28] = {x:3,y:4};
		ppp[29] = {x:3,y:2};
		ppp[30] = {x:4,y:3};
		ppp[31] = {x:6,y:0};
		ppp[32] = {x:5,y:1};
		ppp[33] = {x:4,y:5};
		ppp[34] = {x:4,y:4};
		ppp[35] = {x:6,y:1};
		ppp[36] = {x:7,y:0};
		ppp[37] = {x:5,y:5};
		ppp[38] = {x:5,y:3};
		ppp[39] = {x:5,y:4};
		ppp[40] = {x:7,y:1};
		ppp[42] = {x:8,y:0};
		ppp[44] = {x:6,y:5};
		ppp[46] = {x:4,y:2};
		ppp[50] = {x:7,y:5};
		ppp["step3"] = {x:8,y:2};

    </script>


</html>