<html>
    <head>
        <title>PowuhGred</title>
    </head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>


    <canvas id="mapCanvas" width="1680" height="1050" style=""></canvas>


    <script>
		var DEBUG = false;

		var currentActionState = "unstarted";

		var UNSTARTED_F =	1;
		var AUCTION_F =		2;
		var BID_F = 		4;
		var RESOURCE_F = 	8;
		var CITY_F =		16;
		var MONEY_F =		32;

		var ACTIONS_FLAGS = [];
		ACTIONS_FLAGS[currentActionState] = UNSTARTED_F;
		ACTIONS_FLAGS["startAuction"] = AUCTION_F | BID_F;
		ACTIONS_FLAGS["bid"] = BID_F;
		ACTIONS_FLAGS["buyResources"] = RESOURCE_F;
		ACTIONS_FLAGS["buyCities"] = CITY_F;
		ACTIONS_FLAGS["moneyPhase"] = MONEY_F;

        var socket = io();
        var citiesDef = {};
        var userid = "NO USER ID";
        var selectedCity;

		var selectedBid = 0;
		var selectedPlant = 0;

		// Global stuff
		var resources = {};
		var actualMarket = [];
		var futureMarket = [];

		// Player stuff
		var ownedPlants = [];

        var bgImg = new Image();
        bgImg.src = "./data/germany.jpg";
		var plantImg = new Image();
		plantImg.src = "./data/plants.jpg";

        var mapCanvas = document.getElementById("mapCanvas");
        var ctx = mapCanvas.getContext("2d");

        var consoleHeader = "Console:\n";
		var consoleText = "";
		var consoleHistory = [];
        var log = function(str) {
			console.log(str);
			consoleHistory.push(str);
			if(consoleHistory.length > 15)
				consoleHistory.splice(0, 1);
			consoleText = consoleHeader;
			for(var line in consoleHistory){
				consoleText += consoleHistory[line] + "\n";
			}
			redraw();
		};

        var externalX = function (x) { return x * 1.1 - 5;  };
        var externalY = function (y) { return y * 1.1 - 96; };
        var internalX = function (x) { return (x + 5) / 1.1;  };
        var internalY = function (y) { return (y + 96) / 1.1; };

        var resourceGrid = {};

		// V V V Talk to Kyle before changing ANYTHING V V V
        for(var i = 0; i < 24; i++) {
            var box = {};
            box.type = "coal";
            box.size = 22;
            box.x = internalX((i * (box.size+3)) + (~~(i / 3) * 5) + 37);
            box.y = internalY(949);
            resourceGrid[i] = box;
        }
        for(var i = 0; i < 24; i++) {
            var box = {};
            box.type = "oil";
            box.size = 17;
            box.x = internalX((i * (box.size)) + (~~(i / 3) * 29) + 37);
            box.y = internalY(971);
            resourceGrid[i+24] = box;
        }
        for(var i = 0; i < 24; i++) {
            var box = {};
            box.type = "garbage";
            box.size = 22;
            box.x = internalX((i * (box.size+3)) + (~~(i / 3) * 5) + 37);
            box.y = internalY(990);
            resourceGrid[i+48] = box;
        }
        for(var i = 0; i < 8; i++) {
            var box = {};
            box.type = "uranium";
            if(i <= 9) {
                box.size = 17;
                box.x = internalX(((i*3+2) * (box.size)) + (~~((i*3+2) / 3) * 29) + 37 + 20);
                box.y = internalY(971);
            }
            resourceGrid[i+72] = box;
        }
        for(var i = 0; i < 4; i++) {
            var box = {};
            box.type = "uranium";
            box.size = 25;
            box.x = internalX(((i%2) * (box.size+6)) + 678);
            box.y = internalY(951 + (~~(i/2) * (box.size+11)));
            resourceGrid[i+80] = box;
        }
		// ^ ^ ^ OK, YOU CAN DO SHIT NOW ^ ^ ^

        var buttonArray = {};
        var createButton = function(disp,listener,flags) {
            var button = {};
            button.disp = disp;
            button.listener = listener;
			button.flags = flags;
            button.width = disp.length > 5 ?
					(disp.length > 8 ? disp.length * 8 : disp.length * 9)
					: disp.length * 10;
            button.height = 12;
            buttonArray[disp] = button;
        };

        // store user id
        socket.on('userid', function(data) {userid = data});

        // load up the city map right after connecting
        socket.on('definecities', function(data){

            // get the dictionary of city.js objects (taken from cities.js)
            $.each(data, function(key, value){
                citiesDef[key] = value;
            });

            // load the background image
            bgImg.onload = function() {
                redraw();
            };
        });

        socket.on('updates', function(data) {
            log("RECEIVED on updates:");
			if(data.group == "resourcePool"){
				updateResources(data.args);
			}
			else if(data.group == "playerOrder"){
				updatePlayerOrder(data.args);
			}
			else if(data.group == "currentPlayer"){
				updateCurrentPlayer(data.args);
			}
			else if(data.group == "actualMarket"){
				updateActualMarket(data.args);
			}
			else if(data.group == "futureMarket"){
				updateFutureMarket(data.args);
			}
			else if(data.group == "currentAction"){
				updateCurrentAction(data.args);
			}
			else if(data.group == "money"){
				updateMoney(data.args);
			}
			else if(data.group == "newPlayer"){
				updateNewPlayer(data.args);
			}
			else if(data.group == "name"){
				updatePlayerName(data.args);
			}
			else if(data.group == "auctionStart"){
				updateStartAuction(data.args);
			}
			else if(data.group == "bid"){
				updateNewBid(data.args);
			}
			else if(data.group == "currentBidder"){
				updateCurrentBidder(data.args);
			}
			else{
				log("'" + data.group + "' has no handler!");
			}
        });

		var updateResources = function(data){
			log("Oil: " + data.oil + " - Coal: " + data.coal
					+ " - Garbage: " + data.garbage + " - Uranium: " + data.uranium);
			resources = data;
		};

		var updatePlayerOrder = function(data){
			log("Player Order: " + data);
		};

		var updateCurrentPlayer = function(data){
			log("Current Player: " + data);
		};

		var updateActualMarket = function(data){
			log("Actual Market =>");
			actualMarket = [];
			for(var m in data){
				log("Cost: " + data[m].cost + " Type: " + data[m].type
					+ " Requires: " + data[m].requires + " Powers: " + data[m].powers);
				actualMarket.push(data[m].cost);
			}
		};

		var updateFutureMarket = function(data){
			log("Future Market =>");
			futureMarket = [];
			for(var m in data){
				log("Cost: " + data[m].cost + " Type: " + data[m].type
					+ " Requires: " + data[m].requires + " Powers: " + data[m].powers);
				futureMarket.push(data[m].cost);
			}
		};

		var updateCurrentAction = function(data){
			log("Current Action: " + data);
			currentActionState = data;
		};

		var updateMoney = function(data){
			log(data.uid + " now has " + data.money + " money");
		};

		var updateNewPlayer = function(data){
			log(data.uid + " has joined the game");
		};

		var updatePlayerName = function(data){
			log(data.uid + " has changed their name to " + data.displayName);
		};

		var updateStartAuction = function(data){
			log(data.uid + " has started an auction on power plant: "
					+ data.cost + " with bid " + data.bid);
		};

		var updateNewBid = function(data){
			log(data.uid + " placed a new bid of " + data.bid);
		};

		var updateCurrentBidder = function(data){
			log(data.uid + " must now place a bid or pass");
		};

        var redraw = function() {
			ctx.fillStyle = "#FFFFFF";
			ctx.fillRect(0,0,1680,1050);
            ctx.drawImage(bgImg, 0, 0);

            // draw internal city map
            $.each(citiesDef, function(key, city){
                ctx.strokeStyle = "#444444";
                ctx.fillStyle = "#FFFFFF";
                ctx.lineWidth = 2;
				if(DEBUG){
					ctx.beginPath();
					var x = externalX(city.x);
					var y = externalY(city.y);
					ctx.arc(x, y, 20, 0, 360, false);
					ctx.stroke();

					ctx.font = "10px Arial";
					ctx.fillText(city.name.toUpperCase(),x,y);
				}
            });

            // draw internal resource grid
			var regular = 24;
			var uranium = 12;
            $.each(resourceGrid, function(key,box) {
                ctx.strokeStyle = "#0000FF";
                if(box.type==="coal") {ctx.strokeStyle = ctx.fillStyle = "#452E17";}
                if(box.type==="oil") {ctx.strokeStyle = ctx.fillStyle = "#000000";}
                if(box.type==="uranium") {ctx.strokeStyle = ctx.fillStyle = "#00CC00";}
                if(box.type==="garbage") {ctx.strokeStyle = ctx.fillStyle = "#FFFF19";}
                ctx.lineWidth = 1;


				var x = externalX(box.x);
				var y = externalY(box.y);

				if(DEBUG){
					ctx.beginPath();
					ctx.rect(x, y, box.size, box.size);
					ctx.stroke();
				}

				// Draw resource unit
				if(box.type == "coal" && key % regular  >= 24 - resources.coal){
					ctx.fillRect(x + box.size / 8,y + box.size / 8,
									box.size * (3/4),box.size * (3/4));
				}
				if(box.type == "oil" && key % regular  >= 24 - resources.oil){
					ctx.fillRect(x + box.size / 8,y + box.size / 8,
									box.size * (3/4),box.size * (3/4));
				}
				if(box.type == "garbage" && key % regular  >= 24 - resources.garbage){
					ctx.fillRect(x + box.size / 8,y + box.size / 8,
									box.size * (3/4),box.size * (3/4));
				}
				if(box.type == "uranium" && key % uranium  >= 12 - resources.uranium){
					ctx.fillRect(x + box.size / 8,y + box.size / 8,
									box.size * (3/4),box.size * (3/4));
				}
            });

            // highlight selected city
            if(selectedCity) {
                ctx.strokeStyle = "#DD6622";
                ctx.lineWidth = 3;
                ctx.beginPath();
                var x = externalX(selectedCity.x);
                var y = externalY(selectedCity.y);
                ctx.arc(x, y, 20, 0, 360, false);
                ctx.stroke();
            }

			if(selectedPlant){
				ctx.strokeStyle = "#DD6622";
				ctx.lineWidth = 3;
				ctx.beginPath();
				var x = externalX(805 + actualMarket.indexOf(selectedPlant) * 114);
				var y = externalY(295);
				ctx.strokeRect(x, y, 114, 114);
				ctx.stroke();
			}

            // console output
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(800,600,600,600);
            ctx.fillStyle = "#000000";
            ctx.font = "10px Arial";
            var txt = consoleText.split("\n");
            $.each(txt, function(index, chunk) {
                ctx.fillText(chunk,800,600+15*index);
            });

			// Draw the player's power plants
			var count = 0;
			for(var p in ownedPlants){
				var cost = ownedPlants[p];
				ctx.drawImage(plantImg, ppp[cost].x * pppWidth, ppp[cost].y * pppHeight,
									pppWidth, pppHeight,
									800 + count * 125, 150, pppWidth, pppHeight);
				count += 1;
			}

			// Draw the actual market
			var count = 0;
			ctx.strokeStyle = "#00B8E6";
			ctx.lineWidth = 1;
			ctx.strokeRect(794, 294, 4 * 120 + 7, 125);
			for(var p in actualMarket){
				var cost = actualMarket[p];
				ctx.drawImage(plantImg, ppp[cost].x * pppWidth, ppp[cost].y * pppHeight,
									pppWidth, pppHeight,
									800 + count * 120, 300, pppWidth, pppHeight);
				count += 1;
			}

			// Draw the future market
			count = 0;
			ctx.strokeStyle = "#FF6699";
			ctx.strokeRect(794, 444, 4 * 120 + 7, 125);
			for(var p in futureMarket){
				var cost = futureMarket[p];
				ctx.drawImage(plantImg, ppp[cost].x * pppWidth, ppp[cost].y * pppHeight,
									pppWidth, pppHeight,
									800 + count * 120, 450, pppWidth, pppHeight);
				count += 1;
			}


            // draw buttons
			ctx.fillStyle = "#FFFFFF";
			var currentWidth = 800;
			var bufferSpace = 5;
            for(key in buttonArray) {
				var btn = buttonArray[key];

				var cur = ACTIONS_FLAGS[currentActionState];
				var flag = btn.flags;
				if((cur & flag) > 0){
					ctx.fillStyle = "#009900";
					ctx.strokeStyle = "#009900";
					ctx.lineWidth = 1;
					var pos = currentWidth;
					btn.x = pos;
					btn.y = 5;
					ctx.strokeRect(pos, 5, btn.width, btn.height);
					ctx.font = "12px monospace";
					ctx.fillText(btn.disp, pos + 5, 15);
					currentWidth = pos + btn.width + bufferSpace;
				}
				else{
					btn.x = -1;
					btn.y = -1;
				}
            }
        };

        var sqrDist = function(x1,x2,y1,y2) { return Math.pow(x1-x2,2)+Math.pow(y1-y2,2) };

        mapCanvas.addEventListener('click', function(event) {
            var x = event.pageX - 8;
			var y = event.pageY - 8;

			log("Click: " + x + ", " + y);

			selectedPlant = null;
			selectedCity = null;

            for(key in buttonArray) {
				var btn = buttonArray[key];
                if(x > btn.x && x < (btn.x + btn.width) && y > btn.y && y < (btn.y + btn.height)) {
                    btn.listener();
					return;
                }
            }

			if(x > 800 && x < 1280 && y > 300 && y < 420){
				selectedPlant = Math.floor((1280 - x) / 114);
				return;
			}

			x = internalX(event.pageX - 8);
			y = internalY(event.pageY - 8);
            $.each(citiesDef,function(key,city) {
                if(sqrDist(x,city.x,y,city.y)<500) {selectedCity = city;}
            });
            redraw();
        },false);

		var startGameButton = function(){
			socket.emit('gameaction', {uid:userid, cmd:"startGame", args:{}});
		};

		var passButton = function(){
			socket.emit('gameaction', {uid:userid, cmd:"pass", args:{}});
		};

		var startAuctionButton = function(){
			socket.emit('gameaction', {uid:userid, cmd:"startAuction",
				args:{cost:selectedPlant,bid:selectedBid}});
		};

		var bidUpButton = function(){
			selectedBid += 1;
			log("Bid amount: $" + selectedBid);
		};

		var bidDownButton = function(){
			selectedBid -= 1;
			log("Bid amount: $" + selectedBid);
		};

		var confirmBidButton = function(){
			socket.emit('gameaction', {uid:userid, cmd:"bid", args:{bid:selectedBid}});
		};

        // createButton( Display, Cmd, Args, x,y,w,h);
        createButton("Start Game!", startGameButton, UNSTARTED_F);
        createButton("Pass", passButton, UNSTARTED_F | AUCTION_F | BID_F | RESOURCE_F | CITY_F | MONEY_F);
		createButton("Start Auction", startAuctionButton, AUCTION_F);
		createButton("Bid Up", bidUpButton, AUCTION_F | BID_F);
		createButton("Bid Down", bidDownButton, AUCTION_F | BID_F);
		createButton("Confirm Bid", confirmBidButton, AUCTION_F | BID_F);

		// Card positions
		var pppWidth = 114;
		var pppHeight = 114;
		var ppp = [];
		ppp[3]  = {x:0,y:1};
		ppp[4]  = {x:0,y:0};
		ppp[5]  = {x:0,y:2};
		ppp[6]  = {x:0,y:3};
		ppp[7]  = {x:1,y:1};
		ppp[8]  = {x:1,y:0};
		ppp[9]  = {x:2,y:1};
		ppp[10] = {x:2,y:0};
		ppp[11] = {x:0,y:4};
		ppp[12] = {x:1,y:2};
		ppp[13] = {x:0,y:5};
		ppp[14] = {x:1,y:3};
		ppp[15] = {x:3,y:0};
		ppp[16] = {x:3,y:1};
		ppp[17] = {x:1,y:4};
		ppp[18] = {x:1,y:5};
		ppp[19] = {x:2,y:3};
		ppp[20] = {x:4,y:0};
		ppp[21] = {x:2,y:2};
		ppp[22] = {x:2,y:5};
		ppp[23] = {x:2,y:4};
		ppp[24] = {x:3,y:3};
		ppp[25] = {x:5,y:0};
		ppp[26] = {x:4,y:1};
		ppp[27] = {x:3,y:5};
		ppp[28] = {x:3,y:4};
		ppp[29] = {x:3,y:2};
		ppp[30] = {x:4,y:3};
		ppp[31] = {x:6,y:0};
		ppp[32] = {x:5,y:1};
		ppp[33] = {x:4,y:5};
		ppp[34] = {x:4,y:4};
		ppp[35] = {x:6,y:1};
		ppp[36] = {x:7,y:0};
		ppp[37] = {x:5,y:5};
		ppp[38] = {x:5,y:3};
		ppp[39] = {x:5,y:4};
		ppp[40] = {x:7,y:1};
		ppp[42] = {x:8,y:0};
		ppp[44] = {x:6,y:5};
		ppp[46] = {x:4,y:2};
		ppp[50] = {x:7,y:5};
		ppp["step3"] = {x:8,y:2};

    </script>


</html>